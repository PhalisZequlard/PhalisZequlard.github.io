<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" maximum-scale=1.0, user-scalable=no>
  <link rel="stylesheet" href="testing_style.css">
  <title>textData</title>
</head>
<header id="main-header">
  <h2>WANT</h2>
  <h1>EATS</h1>
  <a href="testing_police.html">繼續使用代表你同使用條款</a>
</header>
<body class="no-scroll">

  <div class="Login">
    <div>
      <p>外送：現在</p>
      <p>南台科技大學</p>
    </div>
    <div class="sign">
      <div>
        <svg><path fill="white" d="M18.958 7.042a5.958 5.958 0 11-11.916 0 5.958 5.958 0 0111.916 0zM3.25 21.667c0-3.575 2.925-6.5 6.5-6.5h6.5c3.575 0 6.5 2.925 6.5 6.5v3.25H3.25v-3.25z"></path></svg>
      </div>
      <button type="button" id="googleLoginBtn">Login</button>
      <button type="button" id="googleLogoutBtn" style="display:none;">Logout</button>
    </div>
  </div>
  <div class="Search">
    <div>
      <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 48 48" width="30px" height="30px"><path d="M 20.5 6 C 12.515556 6 6 12.515562 6 20.5 C 6 28.484438 12.515556 35 20.5 35 C 23.773158 35 26.788919 33.893018 29.220703 32.050781 L 38.585938 41.414062 A 2.0002 2.0002 0 1 0 41.414062 38.585938 L 32.050781 29.220703 C 33.893017 26.788918 35 23.773156 35 20.5 C 35 12.515562 28.484444 6 20.5 6 z M 20.5 10 C 26.322685 10 31 14.677319 31 20.5 C 31 23.295711 29.914065 25.820601 28.148438 27.697266 A 2.0002 2.0002 0 0 0 27.701172 28.144531 C 25.824103 29.912403 23.29771 31 20.5 31 C 14.677315 31 10 26.322681 10 20.5 C 10 14.677319 14.677315 10 20.5 10 z"/></svg>
      <p>搜尋 不到東西</p>
    </div>
    <div>
      <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0 0 24 24">
        <path d="M 9.6660156 2 L 9.1757812 4.5234375 C 8.3516137 4.8342536 7.5947862 5.2699307 6.9316406 5.8144531 L 4.5078125 4.9785156 L 2.171875 9.0214844 L 4.1132812 10.708984 C 4.0386488 11.16721 4 11.591845 4 12 C 4 12.408768 4.0398071 12.832626 4.1132812 13.291016 L 4.1132812 13.292969 L 2.171875 14.980469 L 4.5078125 19.021484 L 6.9296875 18.1875 C 7.5928951 18.732319 8.3514346 19.165567 9.1757812 19.476562 L 9.6660156 22 L 14.333984 22 L 14.824219 19.476562 C 15.648925 19.165543 16.404903 18.73057 17.068359 18.185547 L 19.492188 19.021484 L 21.826172 14.980469 L 19.886719 13.291016 C 19.961351 12.83279 20 12.408155 20 12 C 20 11.592457 19.96113 11.168374 19.886719 10.710938 L 19.886719 10.708984 L 21.828125 9.0195312 L 19.492188 4.9785156 L 17.070312 5.8125 C 16.407106 5.2676813 15.648565 4.8344327 14.824219 4.5234375 L 14.333984 2 L 9.6660156 2 z M 11.314453 4 L 12.685547 4 L 13.074219 6 L 14.117188 6.3945312 C 14.745852 6.63147 15.310672 6.9567546 15.800781 7.359375 L 16.664062 8.0664062 L 18.585938 7.40625 L 19.271484 8.5917969 L 17.736328 9.9277344 L 17.912109 11.027344 L 17.912109 11.029297 C 17.973258 11.404235 18 11.718768 18 12 C 18 12.281232 17.973259 12.595718 17.912109 12.970703 L 17.734375 14.070312 L 19.269531 15.40625 L 18.583984 16.59375 L 16.664062 15.931641 L 15.798828 16.640625 C 15.308719 17.043245 14.745852 17.36853 14.117188 17.605469 L 14.115234 17.605469 L 13.072266 18 L 12.683594 20 L 11.314453 20 L 10.925781 18 L 9.8828125 17.605469 C 9.2541467 17.36853 8.6893282 17.043245 8.1992188 16.640625 L 7.3359375 15.933594 L 5.4140625 16.59375 L 4.7285156 15.408203 L 6.265625 14.070312 L 6.0878906 12.974609 L 6.0878906 12.972656 C 6.0276183 12.596088 6 12.280673 6 12 C 6 11.718768 6.026742 11.404282 6.0878906 11.029297 L 6.265625 9.9296875 L 4.7285156 8.59375 L 5.4140625 7.40625 L 7.3359375 8.0683594 L 8.1992188 7.359375 C 8.6893282 6.9567546 9.2541467 6.6314701 9.8828125 6.3945312 L 10.925781 6 L 11.314453 4 z M 12 8 C 9.8034768 8 8 9.8034768 8 12 C 8 14.196523 9.8034768 16 12 16 C 14.196523 16 16 14.196523 16 12 C 16 9.8034768 14.196523 8 12 8 z M 12 10 C 13.111477 10 14 10.888523 14 12 C 14 13.111477 13.111477 14 12 14 C 10.888523 14 10 13.111477 10 12 C 10 10.888523 10.888523 10 12 10 z"></path>
      </svg>
    </div>
  </div>
  <div class="Option">
    <div class="imgList">
      <div>
        <div class="pic"></div>
      </div>
      <div>
        <div class="pic"></div>
      </div>
      <div>
        <div class="pic"></div>
      </div>
      <div>
        <div class="pic"></div>
      </div>
    </div>
    <div class="txtList">
      <p>餐廳</p>
      <p>生鮮雜貨</p>
      <p>便利商店</p>
      <p>查看全部</p>
    </div>
  </div>

  <!-- spacer -->
  <div style="height: 5px; width: 100vw; background-color: rgb(230, 230, 230);"></div>
  
  <div class="Restaurant">
    <div class="notice">
      <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0 0 30 30">
        <path d="M15,3C8.373,3,3,8.373,3,15c0,6.627,5.373,12,12,12s12-5.373,12-12C27,8.373,21.627,3,15,3z M16,21h-2v-7h2V21z M15,11.5 c-0.828,0-1.5-0.672-1.5-1.5s0.672-1.5,1.5-1.5s1.5,0.672,1.5,1.5S15.828,11.5,15,11.5z"></path>
      </svg>
      <p style="align-items: self-end;">^ 可能需支付天價的服務費</p>
    </div>
    <div id="restaurantContainer"></div>

    <!-- <div style="align-self: center;margin: 10px 0;">- 新增餐廳,需管理員權限 -</div> -->
    <!-- spacer -->
    <div style="height: 5px;width: 100vw;background-color: rgb(230, 230, 230);align-self: center;margin: 10px 0;"></div>
    
    <h2 class="adminOnly">新增店家</h2>
    <form class="adminOnly" id="restaurantForm">
      <label for="name">店家名稱</label>
      <input placeholder="Restaurant Name" type="text" id="name" name="name">

      <label for="foodimg">圖片連結</label>
      <input placeholder="Image url" type="text" id="foodimg" name="foodimg">

      <div>
        <label for="rate">網路評分</label>
        <input placeholder="Score" type="text" id="rate" name="rate">

        <label for="waitfor">等待時間</label>
        <input placeholder="Time" type="text" id="waitfor" name="waitfor">
      </div>

      <button type="button" id="addRestaurant">新增店家</button>
    </form>
  </div>
  




  <!-- <button id="checkAdminStatus">檢查管理員狀態</button> -->
  <!-- <div id="adminStatus">test</div> -->

  <div style="align-self: center;margin: 10px 0;">- 訊息測試中心 -</div>

  <!-- <div></div> -->
  <div class="msgTestingTable">
    <ul id="msgList"></ul>
    <div id="msgtable" style="display: flex; flex-direction: row;">
      <input placeholder="寫下個性留言" type="text" name="" id="input">
      <button type="button" id="btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="none" class="h-4 w-4 m-1 md:m-0" stroke-width="2">
          <path d="M.5 1.163A1 1 0 0 1 1.97.28l12.868 6.837a1 1 0 0 1 0 1.766L1.969 15.72A1 1 0 0 1 .5 14.836V10.33a1 1 0 0 1 .816-.983L8.5 8 1.316 6.653A1 1 0 0 1 .5 5.67V1.163Z" fill="currentColor"></path>
        </svg>
      </button>
    </div>
  </div>
  







  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyC2wGJaAsQTdMP6VOiVtAl4DGlToiSvwSY",
      authDomain: "nomadic-bison-390822.firebaseapp.com",
      databaseURL: "https://nomadic-bison-390822-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "nomadic-bison-390822",
      storageBucket: "nomadic-bison-390822.appspot.com",
      messagingSenderId: "128137030974",
      appId: "1:128137030974:web:9747a3640eae3d445cd06f",
      measurementId: "G-GN70PHQBBG"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const msgRef = ref(database, "/user/");
    let currentUsername = null;
    const fetchMessages = async () => {
      try {
        const messagesSnapshot = await get(msgRef);
        if (messagesSnapshot.exists()) {
          const messages = messagesSnapshot.val();
          $("#msgList").empty();
          for (const username in messages) {
            $("#msgList").append(`
              <li>
                <h4>${username}</h4>
                <p>${messages[username].text}</p>
              </li>
            `);
          }
        } else {
          console.log("No messages found");
        }
      } catch (error) {
        console.error("Failed to fetch messages:", error);
      }
    };
    fetchMessages();

    const restaurantRef = ref(database, "/order/restaurant/");
    const fetchRestaurants = async () => {
      const restaurantSnapshot = await get(restaurantRef);
      const restaurants = restaurantSnapshot.val();
      for (const restaurantName in restaurants) {
        const rate = restaurants[restaurantName].rate;
        const waitfor = restaurants[restaurantName].waitfor;
        const foodimg = restaurants[restaurantName].foodimg;

        const restaurantBox = `
          <div class="box">
            <div class="img" style="background: url(${foodimg});background-size: cover;background-position: center;"></div>
            <div class="txt">
              <div>
                <h4>${restaurantName}</h4>
                <p>0$ 外送費・${waitfor} min</p>
              </div>
              <p>${rate}</p>
            </div>
          </div>
        `;
        $("#restaurantContainer").append(restaurantBox);
      }
    };
    


    // 在適當的地方調用 fetchMessages 函數
    $(document).ready(function(){
      fetchRestaurants();
      $("#addRestaurant").click(async function() {
        const name = $("#name").val();
        const foodimg = $("#foodimg").val();
        const rate = $("#rate").val();
        const waitfor = $("#waitfor").val();

        if (name && rate && waitfor) {
          const newRestaurantRef = ref(database, `/order/restaurant/${name}`);
          await set(newRestaurantRef, {
            foodimg: foodimg,
            rate: rate,
            waitfor: waitfor
          });
          fetchRestaurants();
        } else {
          alert("所有欄位都是必填的！");
        }
      });

      $("#btn").click(async function() {
        if (currentUsername) {
          const userMsgRef = ref(database, `/user/${currentUsername}`);
          var msg = $("#input").val();
          console.log(msg);
          await set(userMsgRef, {
            text: msg
          });
          fetchMessages();
        } else {
          console.error("User is not logged in");
        }
      });
    });

    // Google Login
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    // 使用Google帳號登入
    $("#googleLoginBtn").click(function() {
      signInWithPopup(auth, provider).catch((error) => {
        console.error(error);
      });
    });
    // 登出功能
    $("#googleLogoutBtn").click(function() {
      signOut(auth).catch((error) => {
        console.error(error);
      });
    });

    // 監聽身份驗證狀態的更改
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // 用戶已登入
        currentUsername = user.displayName || user.email;
        $("#googleLoginBtn").hide();
        $("#googleLogoutBtn").show();
        fetchMessages();

        try {
          // 嘗試檢查是否是管理員
          const adminRef = ref(database, `/admins/${user.uid}`);
          const snapshot = await get(adminRef);
          if (snapshot.exists()) {
            // 用戶是管理員，顯示所有 class="adminOnly" 的元素
            $(".adminOnly").show();
          } else {
            // 用戶不是管理員，刪除所有 class="adminOnly" 的元素
            $(".adminOnly").remove();
          }
        } catch (error) {
          if (error.message === "Permission denied") {
            // 訪問被拒絕，用戶不是管理員
            $(".adminOnly").remove();
          } else {
            console.error("檢查管理員狀態失敗：", error);
          }
        }
      } else {
        // 用戶已登出
        currentUsername = null;
        $("#googleLoginBtn").show();
        $("#googleLogoutBtn").hide();
        $(".adminOnly").remove();  // 用戶登出，刪除所有 class="adminOnly" 的元素
      }
    });


    // 檢查用戶是否是管理員 button
    document.getElementById("checkAdminStatus").addEventListener("click", function() {
    // 檢查用戶是否是管理員
    const adminRef = ref(database, `/admins/${auth.currentUser.uid}`);
    get(adminRef).then((snapshot) => {
      console.log("檢查管理員狀態...");  // 調試信息
      const adminStatusDiv = document.getElementById('adminStatus');
      if (adminStatusDiv) {
        console.log("找到管理員狀態 div");  // 調試信息
        if (snapshot.exists()) {
          // 用戶是管理員
          console.log("用戶是管理員");  // 調試信息
          adminStatusDiv.innerHTML = '您是管理員。';
        } else {
          // 用戶不是管理員
          console.log("用戶不是管理員");  // 調試信息
          adminStatusDiv.innerHTML = '您不是管理員。';
        }
      } else {
        console.log("未找到管理員狀態 div");  // 調試信息
      }
    }).catch((error) => {
      console.error("檢查管理員狀態失敗：", error);  // 調試信息
      const adminStatusDiv = document.getElementById('adminStatus');
      adminStatusDiv.innerHTML = '您不是管理員';
    });
  });


  document.addEventListener('DOMContentLoaded', function() {
    const header = document.querySelector('header');
    header.addEventListener('click', function() {
      header.style.opacity = '0';
      document.body.classList.remove('no-scroll');
      setTimeout(() => {
        header.remove();
      }, 1000);
    });
  });
  </script>
</body>
</html>
