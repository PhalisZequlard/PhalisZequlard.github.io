<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      --box-size: 90%;
      font-family: 'Noto Sans TC', sans-serif, Play, 'Gill Sans';
    }
    ::-webkit-scrollbar {
      display: none;
    }
    header {
      display: flex;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      height: 60px;
      background-color: #2d3943;
      margin-bottom: 20px;
    }
    header > div {
      display: flex;
      flex-direction: row;
      align-items: center;
      width: var(--box-size);
      gap: 10px;
    }
    header > div > svg {
      fill: white;
      height: 33px;
      width: 33px;
    }
    header > div > h1 {
      color: white;
      font-size: 31px;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    body > h2 {
      width: var(--box-size);
      color: #2b87d3;
    }
    body ul {
      display: flex;
      flex-direction: column;
      align-items: center;
      list-style: none;
      width: var(--box-size);

    }
    body ul li {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0;
      /* border-bottom: 1px solid #ccc; */
      width: 100%;
    }
    body ul li p {
      width: 100%;
      font-size: 20px;
      font-weight: 900;
    }
    body ul li div > svg {
      fill: white;
      height: 30px;
      width: 30px;
      margin: 10px 12px;

    }
    body ul li button > svg {
      fill: white;
      height: 30px;
      width: 30px;
    }
    body ul li svg path {
      fill: white;
    }
    body ul li div {
      display: flex;
      width: 100%;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      background-color: #2D3943;
      color: white;
    }
    body .user-list li div button {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 30px;
      width: 30px;
      cursor: pointer;
      background-color: #1fd78d;
      border-radius: 3px;
      border: none;
      padding: 3px 5px;
      margin: 10px 12px;

    }
    body .admin-list li div button {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 30px;
      width: 30px;
      cursor: pointer;
      background-color: #F62451;
      border-radius: 3px;
      border: none;
      padding: 3px 5px;
      margin: 10px 12px;

    }
    footer {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      width: var(--box-size);
      gap: 20px;
      margin: 10px 0 20px 0;
    }
    footer svg {
      fill: white;
      height: 30px;
      width: 30px;
    }
    footer div {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 50px;
      width: 100%;
      background-color: #2D3943;
      font-size: 22.5px;
      font-weight: 900;
      color: white;
      cursor: pointer;
    }
    footer div:nth-child(1) {
      background-color: #2b87d3;
    }
    footer div:nth-child(2) {
      background-color: #eb7b59;
    }
    footer div a {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      color: white;
      text-decoration: none;
      gap: 8px;
    }
    @media screen and (max-width: 500px) {
      footer div {
        font-size: 18px;
      }
      footer a svg {
        height: 25px;
        width: 25px;
      }
    }
    @media screen and (max-width: 430px) {
      footer div {
        font-size: 16px;
      }
      footer a svg {
        height: 24px;
        width: 24px;
      }
    }
    @media screen and (max-width: 385px) {
      header > div > svg {
        height: 30px;
        width: 30px;
      }
      header > div > h1 {
        font-size: 27px;
      }
      footer div {
        font-size: 13px;
      }
      footer a svg {
        height: 22px;
        width: 22px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" fill="none"/><path fill-rule="evenodd" clip-rule="evenodd" d="M7.29291 14.2929C6.90238 14.6834 6.90238 15.3166 7.29291 15.7071C7.68343 16.0976 8.31659 16.0976 8.70712 15.7071L11.2071 13.2071C11.8738 12.5404 11.8738 11.4596 11.2071 10.7929L8.70712 8.29289C8.3166 7.90237 7.68343 7.90237 7.29291 8.29289C6.90238 8.68342 6.90238 9.31658 7.29291 9.70711L9.5858 12L7.29291 14.2929ZM13 14C12.4477 14 12 14.4477 12 15C12 15.5523 12.4477 16 13 16H16C16.5523 16 17 15.5523 17 15C17 14.4477 16.5523 14 16 14H13ZM22 7.93418C22 7.95604 22 7.97799 22 8.00001L22 16.0658C22.0001 16.9523 22.0001 17.7161 21.9179 18.3278C21.8297 18.9833 21.631 19.6117 21.1213 20.1213C20.6117 20.631 19.9833 20.8297 19.3278 20.9179C18.7161 21.0001 17.9523 21.0001 17.0658 21L6.9342 21C6.0477 21.0001 5.28388 21.0001 4.67222 20.9179C4.0167 20.8297 3.38835 20.631 2.87869 20.1213C2.36902 19.6117 2.17028 18.9833 2.08215 18.3278C1.99991 17.7161 1.99995 16.9523 2 16.0658L2 7.9342C1.99995 7.0477 1.99991 6.28388 2.08215 5.67221C2.17028 5.0167 2.36902 4.38835 2.87869 3.87868C3.38835 3.36902 4.0167 3.17028 4.67222 3.08215C5.28388 2.99991 6.04769 2.99995 6.93418 3L17 3.00001C17.022 3.00001 17.044 3 17.0658 3C17.9523 2.99995 18.7161 2.99991 19.3278 3.08215C19.9833 3.17028 20.6117 3.36902 21.1213 3.87869C21.631 4.38835 21.8297 5.0167 21.9179 5.67221C22.0001 6.28387 22.0001 7.04769 22 7.93418Z" fill="white"/></svg>
      <h1>ADMIN TERMINAL</h1>
    </div>
  </header>

  <h2>Admins</h2>
  <ul class="admin-list"></ul>
  
  <h2>Users</h2>
  <ul class="user-list"></ul>

  <footer>
    
    <div><a href="testing.html">
      <svg viewBox="0 0 960 960" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M697.234 663.371C716.41 696.729 667.671 724.494 648.395 693.333C606.548 628.614 569.794 560.699 528.745 495.381C516.161 464.219 479.107 431.161 495.986 396.005C540.43 337.178 577.384 418.776 594.363 456.829C639.506 550.512 610.443 525.243 710.717 524.544C754.263 524.644 758.757 591.361 715.312 596.155C698.732 598.052 682.453 597.852 665.674 598.252C677.159 619.725 684.95 642.297 697.234 663.371Z" fill="none"/>
        <path d="M474.312 257.679C486.597 230.913 517.059 198.453 545.224 224.92C564.3 242.298 551.316 269.465 538.332 287.242C489.194 363.747 450.242 445.844 405.598 524.845C445.448 528.341 485.598 525.844 525.149 532.835C564.1 539.827 558.907 597.455 519.256 598.353C442.153 601.35 365.049 595.457 287.845 599.652C260.28 597.554 225.024 612.336 203.751 589.065C161.104 516.456 275.761 527.442 317.608 524.546C343.776 499.377 356.659 456.93 377.833 425.769C395.311 394.608 412.39 363.147 429.868 331.986C432.964 322.199 418.982 314.109 415.486 305.12C349.169 230.713 442.153 172.885 474.312 257.679Z" fill="none"/>
        <path d="M330.292 643.197C329.393 609.04 284.549 595.856 265.373 626.118C256.884 640.301 246.097 654.483 242.302 670.763C234.811 703.022 275.56 724.995 298.332 700.925C313.513 684.645 325.198 664.87 330.292 643.197ZM545.223 224.92C516.959 198.353 486.597 230.813 474.312 257.679C442.152 172.885 349.068 230.713 415.485 305.22C418.981 314.208 432.864 322.198 429.867 332.086C412.389 363.347 395.311 394.708 377.833 425.869C356.659 457.03 343.775 499.377 317.608 524.645C275.76 527.442 161.103 516.455 203.85 589.165C225.123 612.535 260.379 597.654 287.945 599.751C365.148 595.557 442.152 601.449 519.356 598.453C559.006 597.554 564.2 539.926 525.248 532.935C485.698 525.944 445.548 528.341 405.698 524.945C450.342 445.944 489.293 363.746 538.432 287.342C551.316 269.564 564.299 242.398 545.223 224.92ZM342.277 86.6927C463.326 84.6952 587.87 65.619 705.523 104.97C830.467 143.522 874.012 278.153 872.814 397.105C873.713 481.299 874.012 566.193 858.931 649.19C834.262 804.895 746.172 873.01 590.666 874.608C422.377 880.301 172.489 908.965 104.474 711.012C76.5092 599.452 86.6964 481.1 88.1946 366.843C98.9811 200.75 163.301 90.2882 342.277 86.6927ZM715.411 596.156C758.856 591.362 754.362 524.645 710.816 524.545C610.542 525.244 639.605 550.513 594.462 456.83C577.383 418.778 540.529 337.279 496.085 396.006C479.206 431.062 516.359 464.121 528.844 495.382C569.892 560.6 606.647 628.515 648.494 693.334C667.77 724.495 716.509 696.73 697.333 663.372C685.048 642.298 677.258 619.726 665.773 598.253C682.452 597.854 698.831 598.053 715.411 596.156Z" fill="white"/>
        <path d="M265.471 626.12C284.647 595.758 329.491 609.042 330.39 643.199C325.296 664.872 313.511 684.647 298.53 701.027C275.758 724.997 235.009 703.124 242.5 670.864C246.195 654.485 256.882 640.302 265.471 626.12Z" fill="none"/>
      </svg>
      BackTo APP
    </a></div>
    <div><a href="" onclick="exportDataToJSON()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M2 6.94975C2 6.06722 2 5.62595 2.06935 5.25839C2.37464 3.64031 3.64031 2.37464 5.25839 2.06935C5.62595 2 6.06722 2 6.94975 2C7.33642 2 7.52976 2 7.71557 2.01738C8.51665 2.09229 9.27652 2.40704 9.89594 2.92051C10.0396 3.03961 10.1763 3.17633 10.4497 3.44975L11 4C11.8158 4.81578 12.2237 5.22367 12.7121 5.49543C12.9804 5.64471 13.2651 5.7626 13.5604 5.84678C14.0979 6 14.6747 6 15.8284 6H16.2021C18.8345 6 20.1506 6 21.0062 6.76946C21.0849 6.84024 21.1598 6.91514 21.2305 6.99383C22 7.84935 22 9.16554 22 11.7979V14C22 17.7712 22 19.6569 20.8284 20.8284C19.6569 22 17.7712 22 14 22H10C6.22876 22 4.34315 22 3.17157 20.8284C2 19.6569 2 17.7712 2 14V6.94975Z" fill="white"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M12.25 10C12.25 9.58579 12.5858 9.25 13 9.25H18C18.4142 9.25 18.75 9.58579 18.75 10C18.75 10.4142 18.4142 10.75 18 10.75H13C12.5858 10.75 12.25 10.4142 12.25 10Z" fill="none"/>
        <path d="M16.9856 3.02094C16.8321 3 16.6492 3 16.2835 3H12L12.3699 3.38312C13.0359 4.07299 13.2919 4.33051 13.5877 4.50096C13.7594 4.5999 13.9415 4.67804 14.1304 4.73383C14.4559 4.82993 14.8128 4.83538 15.7546 4.83538L16.089 4.83538C17.0914 4.83536 17.8995 4.83535 18.5389 4.91862C18.6984 4.93939 18.8521 4.96582 19 5C18.8144 3.96313 18.0043 3.15985 16.9856 3.02094Z" fill="white"/>
      </svg>
      Goto Data
    </a></div>
  </footer>
  
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyC2wGJaAsQTdMP6VOiVtAl4DGlToiSvwSY",
      authDomain: "nomadic-bison-390822.firebaseapp.com",
      databaseURL: "https://nomadic-bison-390822-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "nomadic-bison-390822",
      storageBucket: "nomadic-bison-390822.appspot.com",
      messagingSenderId: "128137030974",
      appId: "1:128137030974:web:9747a3640eae3d445cd06f",
      measurementId: "G-GN70PHQBBG"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    

    // Google Login
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    // Google帳號登入介面
    $("#loginbutton, #googleLoginBtn").click(function() {
      window.location.href = "testing_login.html";
    });


    async function fetchAndDisplayData() {
      // 讀取管理員數據
      const adminRef = ref(database, 'admins');
      const adminSnapshot = await get(adminRef);
      const adminData = adminSnapshot.val();
      
      for (const [uid, info] of Object.entries(adminData)) {
        $('.admin-list').append(`
          <li>
            <div>
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="6.75" r="4" fill="white"/><path d="M20 17.5C20 19.9853 20 22 12 22C4 22 4 19.9853 4 17.5C4 15.0147 7.58172 13 12 13C16.4183 13 20 15.0147 20 17.5Z" fill="white"/></svg>
              <p>${info.name}</p>
              <button class="demote-admin-btn" data-uid="${uid}">
                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.937 4.5H11.9362H8.0632C8.02115 4.33649 8.00031 4.16864 8.00031 4.00049C8.00031 2.89728 8.8974 1.99976 10.0001 1.99976C11.1028 1.99976 11.9999 2.89728 11.9999 4.00049C11.9999 4.16937 11.9788 4.33716 11.9372 4.49927L11.937 4.5Z" fill="#000000"/><path d="M4.5 5.5C3.94772 5.5 3.5 5.05228 3.5 4.5C3.5 3.94772 3.94772 3.5 4.5 3.5H15.5C16.0523 3.5 16.5 3.94772 16.5 4.5C16.5 5.05228 16.0523 5.5 15.5 5.5H4.5Z" fill="#000000"/><path fill-rule="evenodd" clip-rule="evenodd" d="M14.5 18.5C15.0523 18.5 15.5 18.0523 15.5 17.5V7C15.5 6.44772 15.0523 6 14.5 6H5.5C4.94772 6 4.5 6.44772 4.5 7V17.5C4.5 18.0523 4.94772 18.5 5.5 18.5H14.5ZM12.5 8.5C12.5 8.22386 12.7239 8 13 8C13.2761 8 13.5 8.22386 13.5 8.5V15.5C13.5 15.7761 13.2761 16 13 16C12.7239 16 12.5 15.7761 12.5 15.5V8.5ZM10 8C9.72386 8 9.5 8.22386 9.5 8.5V15.5C9.5 15.7761 9.72386 16 10 16C10.2761 16 10.5 15.7761 10.5 15.5V8.5C10.5 8.22386 10.2761 8 10 8ZM6.5 8.5C6.5 8.22386 6.72386 8 7 8C7.27614 8 7.5 8.22386 7.5 8.5V15.5C7.5 15.7761 7.27614 16 7 16C6.72386 16 6.5 15.7761 6.5 15.5V8.5Z" fill="#000000"/></svg>
              </button>
            </div>

          </li>
        `);
            // <p>${uid}</p>
      }
      
      // 讀取一般使用者數據
      const userRef = ref(database, 'user');
      const userSnapshot = await get(userRef);
      const userData = userSnapshot.val();
      
      for (const [name, info] of Object.entries(userData)) {
        // 在添加到使用者列表前，先確認他們不是管理員
        if (!adminData.hasOwnProperty(info.uid)) {
          $('.user-list').append(`
            <li>
              <div>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="6.75" r="4" fill="white"/><path d="M20 17.5C20 19.9853 20 22 12 22C4 22 4 19.9853 4 17.5C4 15.0147 7.58172 13 12 13C16.4183 13 20 15.0147 20 17.5Z" fill="white"/></svg>

                <p>${name}</p>
                <button class="promote-user-btn" data-uid="${info.uid}">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2C16.714 2 19.0711 2 20.5355 3.46447C22 4.92893 22 7.28595 22 12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22ZM12 8.25C12.4142 8.25 12.75 8.58579 12.75 9V11.25H15C15.4142 11.25 15.75 11.5858 15.75 12C15.75 12.4142 15.4142 12.75 15 12.75H12.75L12.75 15C12.75 15.4142 12.4142 15.75 12 15.75C11.5858 15.75 11.25 15.4142 11.25 15V12.75H9C8.58579 12.75 8.25 12.4142 8.25 12C8.25 11.5858 8.58579 11.25 9 11.25H11.25L11.25 9C11.25 8.58579 11.5858 8.25 12 8.25Z"/></svg>
                </button>
              </div>

            </li>
          `);
              // <p>${info.uid}</p>
        }
      }
    }

    // 執行函數
    fetchAndDisplayData();

    // Demote admin to user
    $(document).on('click', '.demote-admin-btn', async function() {
      const uid = $(this).data('uid');
      const adminRef = ref(database, `admins/${uid}`);
      await set(adminRef, null);
      fetchAndDisplayData();
      window.location.href = "testing_admin.html";
    });

    // Promote user to admin
    $(document).on('click', '.promote-user-btn', async function() {
      const uid = $(this).data('uid');
      
      // 從使用者數據中取得名稱
      const userRef = ref(database, `user`);
      const snapshot = await get(userRef);
      let name = "";
      Object.entries(snapshot.val()).forEach(([key, value]) => {
        if (value.uid === uid) {
          name = key;
        }
      });

      if(name === "") {
        console.error("No matching user found for the given UID");
        return;
      }

      // 將使用者升級為管理員
      const newAdminRef = ref(database, `admins/${uid}`);
      await set(newAdminRef, { name: name });

      
      fetchAndDisplayData();
      window.location.href = "testing_admin.html";
    });


    // 檢查使用者是否為管理員, 若不是則導回登入頁面
    async function checkAdminStatus(uid) {
      try {
        const adminRef = ref(database, `admins/${uid}`);
        const snapshot = await get(adminRef);
        if (!snapshot.exists()) {
          console.log("Not an admin, redirecting...");
          window.location.href = "testing.html";
        }
      } catch (error) {
        console.error("Error checking admin status:", error);
        window.location.href = "testing.html";
      }
    }
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const uid = user.uid;
        await checkAdminStatus(uid);
      } else {
        window.location.href = "testing.html";
      }
    });
    
    async function exportDataToJSON() {
      // 讀取所有數據
      const rootRef = ref(database);
      const snapshot = await get(rootRef);
      const data = snapshot.val();
      
      // 將數據轉換為JSON字符串
      const jsonStr = JSON.stringify(data, null, 2);

      // 創建一個隱藏的下載鏈接
      const blob = new Blob([jsonStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.style.display = "none";
      a.href = url;
      a.download = "data.json";
      
      // 觸發下載
      document.body.appendChild(a);
      a.click();
      
      // 清理
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }


  </script>
</body>
</html>
